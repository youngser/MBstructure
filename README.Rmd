---
output: 
    html_document:
      css: ~/RFolder/pandoc.css
      fig_height: 6
      fig_width: 6
      highlight: pygments
      keep_md: yes
#        number_sections: yes
    theme: cerulean
#        toc: yes
#        toc_depth: 3
#        toc_float: no
---

```{r setup, include=FALSE, results='asis'}
library(knitr)
knitr::opts_chunk$set(echo=TRUE, eval=FALSE,warning=FALSE)

opts_knit$set(aliases=c(h='fig.height', w='fig.width', cap='fig.cap', scap='fig.scap'))                                                                               
opts_knit$set(eval.after = c('fig.cap','fig.scap'))                                                                            
knit_hooks$set(document = function(x) {                                                                                        
          gsub('(\\\\end\\{knitrout\\}[\n]+)', '\\1\\\\noindent ', x)                                                                  
          })

 fn = local({
   i = 0
   function(x) {
     i <<- i + 1
#     paste('Figure ', i, ': ', x, sep = '')
     paste('', '', x, sep = '')
   }
 })


suppressMessages(library(ggplot2))
suppressMessages(library(igraph))
suppressMessages(library(Matrix))
suppressMessages(library(lattice))
suppressMessages(library(mclust))
suppressMessages(library(RColorBrewer))
suppressMessages(library(packcircles))
suppressMessages(library(mvtnorm))
suppressMessages(library(printr))
suppressMessages(library(xtable))

```

## Semiparametric spectral modeling of the Drosophila connectome
**[Department of Applied Mathematics and Statistics](http://engineering.jhu.edu/ams/)**      
**[Center for Imaging Science](http://www.cis.jhu.edu)**  
**[Human Language Technology Center of Excellence](http://hltcoe.jhu.edu)**  
**[Johns Hopkins University](http://www.jhu.edu)**  
and  
**[University of Cincinnati](http://business.uc.edu)**  
and  
**[HHMI Janelia Research Campus](hhmi.org)**  

-----

> C.E. Priebe,  Y. Park, M. Tang, A, Athreya, V. Lyzinski, J. Vogelstein,
Y. Qin, B. Cocanougher, K. Eichler, M. Zlatic, A. Cardona,
"[Semiparametric spectral modeling of the Drosophila connectome](http://arxiv.org/abs/1502.03391)," _Journal of the American Statistical Association Application and Case Studies_, submitted, 2017.


## Abstract

We present semiparametric spectral modeling of the complete larval Drosophila mushroom body connectome. Motivated by a thorough exploratory data analysis of the network via Gaussian mixture modeling (GMM) in the adjacency spectral embedding (ASE) representation space, we introduce the stochastic structure model (SSM) for network modeling and inference. SSM is a generalization of the stochastic block model (SBM) and a special case of the random dot product graph (RDPG) latent position model, and is amenable to semiparametric GMM in the ASE representation space. The resulting connectome code derived via semiparametric GMM composed with ASE captures latent connectome structure and elucidates biologically relevant neuronal properties.

> **Keywords**: Connectome; Network; Graph; Spectral embedding; Mixture model; Clustering

<figure>
<img src="diagram-circuit.jpg" width="700px" />
  <figcaption>Illustration of the larval Drosophila mushroom body connectome as a directed graph on four neuron types.</figcaption>
</figure>

## Data

HHMI Janelia recently reconstructed the complete wiring diagram of the higher order parallel fiber system for associative learning in the larval Drosophila brain, the mushroom body (MB). Memories are thought to be stored as functional and structural changes in connections between neurons, but the complete circuit architecture of a higher-order learning center involved in memory formation or storage has not been known in any organism ... until now. This data set provides a real and important example for initial investigation into synapse-level structural connectome modeling.  

Our MB connectome was obtained via serial section transmission electron microscopy of an entire larval Drosophila nervous system. This connectome contains the entirety of MB intrinsic neurons called Kenyon cells and all of their pre- and post-synaptic partners.

The data, both right and left MB connectomes as well as their meta information, are included in this R package and can be loaded into `R` via `data(MBconnectome)`.

## Codes and Experiments

To run the experiemnts in the paper, please follow these steps.  
(NB: All the codes are in the `demo` folder at [github](https://github.com/youngser/mbstructure).)

### `R` Package

The latest `R` source package can be installed via:
```{r echo=TRUE,eval=FALSE}
install.packages("http://www.cis.jhu.edu/~parky/MBstructure/mbstructure_0.1.0.tar.gz",type="source",method="wget")
```

or via `github`:

```{r echo=TRUE}
require(devtools)
devtools::install_github("youngser/mbstructure")
```

### The larval _Drosophila_ mushroom body connectome

Output of this chunk (Figure 2) is shown [here](demo/sec2.html).

```{r fig2}
library(mbstructure)
data(MBconnectome)

out <- generate.graph(newrdat, vdf.right)
g <- out$g
vdf <- out$vdf
plotConnections(g, vdf)
```

### Spectral clustering

Output of this chunk (Figures 3, 5, 6, 7, Tables 1, 7) is shown [here](demo/sec3.html).

```{r fig4}
dmax <- 50
Xhat <- doEmbed(g, dmax)

Kmax <- 19
mc <- Mclust(Xhat, 2:Kmax)
vdf$cluster <- factor(mc$class)
plotBIC(mc)
plotClustering(Xhat, mc, vdf)
```

### Semiparametric spectral modeling

Output of this chunk (Figures 8, 9, 10, 11, 12, 13) is shown [here](demo/sec4.html).  
Warning: This takes several minutes to run on my laptop!

```{r semipar}
sout4 <- synthMB(g, Xhat, vdf, labK=vdf$type, Khat=4, dtype="truth", doplot=TRUE)
semiout <- plotMLE(Xhat, vdf) 
```


### Discussion

#### Directed! Weighted?

Output of this chunk (Figure 14) is shown [here](demo/disc-1.html).  
Warning: This takes about _half an hour_ to run on my laptop!

```{r weight}
g.w <- out$g.w
compairARI(g, g.w, vdf)
```

#### Synthetic validation

Output of this chunk (Figure 15) is shown [here](demo/disc-2.html).  
Warning: This takes a few minutes to run on my laptop!

```{r synth}
syntheticValidation(g, Xhat, vdf)
```

#### Hemispheric validation: right vs. left

Output of this chunk (Figure 16) is shown [here](demo/disc-3.html).  
Warning: This takes a few minutes to run on my laptop!

```{r g-left}
right.vs.left(Xhat, vdf, semiout$out100)
```

## Software and Hardware Information

```{r vn,echo=TRUE, eval=TRUE}
library(help='mbstructure')
sessionInfo()
```

-----
*prepared by <youngser@jhu.edu> on `r date()`*
